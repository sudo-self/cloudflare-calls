import{a as V,b as R}from"/build/_shared/chunk-X4L47D7F.js";import{e as w,f as L,h as g,i as O,j as z,k as A,m as J,n as F,o as U,p as h,q as b,r as q,s as H,u as M,v as j,w as B}from"/build/_shared/chunk-PYJLC5PR.js";import{a as I}from"/build/_shared/chunk-6M6UZGDQ.js";import{a as N,b as x}from"/build/_shared/chunk-3YOPFW4A.js";import{d as S,f as P,h as D}from"/build/_shared/chunk-5YSEWQXG.js";var p=S(N());var _=S(N());function K(){return(0,_.useSyncExternalStore)(()=>()=>{},()=>!1,()=>!0)}var C,W,y,G,$=class{constructor(e){P(this,C);P(this,y);this.taskScheduler=new V;this.pushTrackDispatcher=new R(32);this.pullTrackDispatcher=new R(32);this.closeTrackDispatcher=new R(32);this.config=e,this.peerConnection$=new w(t=>{let r,n=()=>(r==null||r.close(),r=ee(),r.addEventListener("connectionstatechange",()=>{(r.connectionState==="failed"||r.connectionState==="closed")&&t.next(n())}),Object.assign(window,{explode:()=>{console.debug("\u{1F4A5} Closing connection"),r.close(),r.dispatchEvent(new Event("connectionstatechange"))}}),r);return t.next(n()),()=>{r.close()}}),this.session$=this.peerConnection$.pipe(b(t=>L(this.createSession(t))),h({bufferSize:1,refCount:!0})),this.peerConnectionState$=this.peerConnection$.pipe(b(t=>z(t,"connectionstatechange",()=>t.connectionState)),U())}authHeaders(){return{Authorization:`Bearer ${this.config.token}`}}async createSession(e){console.debug("\u{1F195} creating new session");let{appId:t,apiBase:r,token:n}=this.config;await e.setLocalDescription(await e.createOffer());let{sessionId:c,sessionDescription:o}=await fetch(`${r}/${t}/sessions/new`,{method:"POST",headers:{Authorization:`Bearer ${n}`},body:JSON.stringify({sessionDescription:e.localDescription})}).then(s=>s.json()),l=new Promise((s,a)=>{setTimeout(a,5e3);let u=()=>{e.iceConnectionState==="connected"&&(e.removeEventListener("iceconnectionstatechange",u),s(void 0))};e.addEventListener("iceconnectionstatechange",u)});return await e.setRemoteDescription(o),await l,{peerConnection:e,sessionId:c}}pushTrack(e){let t=e.pipe(J(1),g(()=>crypto.randomUUID())),r=O([t,this.session$]).pipe(H(e),g(([[c,o],l])=>{let s=o.peerConnection.addTransceiver(l,{direction:"sendonly"});return console.debug("\u{1F331} creating transceiver!"),{transceiver:s,stableId:c,session:o}}),h({refCount:!0,bufferSize:1})),n=r.pipe(b(({session:{peerConnection:c,sessionId:o},transceiver:l,stableId:s})=>D(this,C,W).call(this,c,l,o,s)));return O([n,r,e]).pipe(q(([c,{transceiver:o},l])=>{o.sender.transport!==null&&(console.debug("\u267B\uFE0E replacing track"),o.sender.replaceTrack(l))}),g(([c])=>c),h({refCount:!0,bufferSize:1}))}pullTrack(e){return O([this.session$,e.pipe(F((t,r)=>JSON.stringify(t)===JSON.stringify(r)))]).pipe(A(([{peerConnection:t}])=>t.connectionState==="connected"),b(([{peerConnection:t,sessionId:r},n])=>D(this,y,G).call(this,t,r,n)))}async closeTrack(e,t,r){var u;let{appId:n,token:c,apiBase:o}=this.config,l=e.getTransceivers().find(f=>f.mid===t);if(e.connectionState!=="connected"||l===void 0)return;l.direction="inactive",await e.setLocalDescription(await e.createOffer());let s={tracks:[{mid:l.mid}],sessionDescription:{sdp:(u=e.localDescription)==null?void 0:u.sdp,type:"offer"},force:!1},a=await fetch(`${o}/${n}/sessions/${r}/tracks/close`,{method:"PUT",body:JSON.stringify(s),headers:{Authorization:`Bearer ${c}`}}).then(f=>f.json());await e.setRemoteDescription(new RTCSessionDescription(a.sessionDescription))}};C=new WeakSet,W=function(e,t,r,n){return new w(c=>{let o,l=setTimeout(()=>{console.debug("\u{1F4E4} pushing track ",n),o=this.pushTrackDispatcher.doBulkRequest({trackName:n,transceiver:t},s=>this.taskScheduler.schedule(async()=>{var u;await e.setLocalDescription(await e.createOffer());let a=await fetch(`${this.config.apiBase}/${this.config.appId}/sessions/${r}/tracks/new`,{method:"POST",headers:this.authHeaders(),body:JSON.stringify({sessionDescription:{sdp:(u=e.localDescription)==null?void 0:u.sdp,type:"offer"},tracks:s.map(({trackName:f,transceiver:m})=>({trackName:f,mid:m.mid,location:"local"}))})}).then(f=>f.json());return I(a.tracks!==void 0),a.errorCode||await e.setRemoteDescription(new RTCSessionDescription(a.sessionDescription)),{tracks:a.tracks}})).then(({tracks:s})=>{let a=s.find(u=>u.mid===t.mid);a?c.next({...a,sessionId:r,location:"remote"}):c.error(new Error("Missing TrackData"))}).catch(s=>c.error(s))});return()=>{clearTimeout(l),o==null||o.then(()=>{this.taskScheduler.schedule(async()=>(console.debug("\u{1F51A} Closing pushed track ",n),this.closeTrack(e,t.mid,r)))})}})},y=new WeakSet,G=function(e,t,r){let n="";return new w(c=>{let o,l=setTimeout(()=>{console.debug("\u{1F4E5} pulling track ",r.trackName),o=this.pullTrackDispatcher.doBulkRequest(r,s=>this.taskScheduler.schedule(async()=>{var f;let a=await fetch(`${this.config.apiBase}/${this.config.appId}/sessions/${t}/tracks/new`,{method:"POST",headers:this.authHeaders(),body:JSON.stringify({tracks:s})}).then(m=>m.json());if(a.errorCode)throw new Error(a.errorDescription);I(a.tracks);let u=s.reduce((m,T)=>{var E;let k=(E=a.tracks)==null?void 0:E.find(v=>v.trackName===T.trackName&&v.sessionId===T.sessionId);return k&&k.mid&&m.set(T,{mid:k.mid,resolvedTrack:te(e,v=>v.mid===k.mid)}),m},new Map);if(a.requiresImmediateRenegotiation){await e.setRemoteDescription(new RTCSessionDescription(a.sessionDescription));let m=await e.createAnswer();await e.setLocalDescription(m);let T=await fetch(`${this.config.apiBase}/${this.config.appId}/sessions/${t}/renegotiate`,{method:"PUT",body:JSON.stringify({sessionDescription:{type:"answer",sdp:(f=e.currentLocalDescription)==null?void 0:f.sdp}}),headers:this.authHeaders()}).then(k=>k.json());if(T.errorCode)throw new Error(T.errorDescription)}return{trackMap:u}})).then(({trackMap:s})=>{let a=s.get(r);return a?a.resolvedTrack.then(u=>{n=a.mid,c.next(u)}).catch(u=>c.error(u)):c.error(new Error("Missing Track Info")),r.trackName})});return()=>{clearTimeout(l),o==null||o.then(s=>{n&&(console.debug("\u{1F51A} Closing pulled track ",s),this.taskScheduler.schedule(async()=>this.closeTrack(e,n,t)))})}})};function ee(i={iceServers:[{urls:"stun:stun.cloudflare.com:3478"}],bundlePolicy:"max-bundle"}){let e=new RTCPeerConnection(i);return e.addTransceiver("audio",{direction:"inactive"}),e}async function te(i,e,t=5e3){return new Promise((r,n)=>{setTimeout(n,t);let c=()=>{let o=i.getTransceivers().find(e);o&&(r(o.receiver.track),i.removeEventListener("track",c))};i.addEventListener("track",c)})}var d=S(x());function Z(){return K()?null:(0,d.jsx)(re,{})}function re(){let[i,e]=(0,p.useState)(!0),[t,r]=(0,p.useState)(!1),n=(0,p.useMemo)(()=>new $({apiBase:"https://rtc.live.cloudflare.com/v1/apps",appId:"APP_ID",token:"APP_TOKEN"}),[]),c=j(n.peerConnectionState$,"new"),o=j((0,p.useMemo)(()=>n.session$.pipe(g(f=>f.sessionId)),[n.session$]),null),l=ne(i),s=se(i),a=(0,p.useMemo)(()=>!l||!t?null:n.pullTrack(n.pushTrack(l)),[n,t,l]),u=(0,p.useMemo)(()=>!s||!t?null:n.pullTrack(n.pushTrack(s)),[n,t,s]);return(0,d.jsxs)("div",{className:"p-2 flex flex-col gap-3",children:[(0,d.jsxs)("div",{className:"flex gap-2",children:[(0,d.jsxs)(Q,{onClick:()=>e(!i),children:["Turn Local ",i?"Off":"On"]}),(0,d.jsxs)(Q,{onClick:()=>r(!t),children:["Turn Remote ",t?"Off":"On"]})]}),(0,d.jsxs)("div",{className:"grid xl:grid-cols-2",children:[l&&i&&(0,d.jsx)(X,{videoTrack$:l}),s&&i&&(0,d.jsx)(Y,{audioTrack$:s}),a&&t&&(0,d.jsx)(X,{videoTrack$:a}),u&&t&&(0,d.jsx)(Y,{audioTrack$:u})]}),(0,d.jsx)("pre",{children:JSON.stringify({peerConnectionState:c,sessionId:o},null,2)})]})}function Q(i){return(0,d.jsx)("button",{className:"border px-1",...i})}function X(i){let e=(0,p.useRef)(null);return B(i.videoTrack$,t=>{if(e.current)if(t){let r=new MediaStream;r.addTrack(t),e.current.srcObject=r}else e.current.srcObject=null}),(0,d.jsx)("video",{className:"h-full w-full",ref:e,autoPlay:!0,muted:!0,playsInline:!0})}function Y(i){let e=(0,p.useRef)(null);return B(i.audioTrack$,t=>{if(e.current)if(t){let r=new MediaStream;r.addTrack(t),e.current.srcObject=r}else e.current.srcObject=null}),(0,d.jsx)("audio",{className:"h-full w-full",ref:e,autoPlay:!0,playsInline:!0})}function ne(i){return(0,p.useMemo)(()=>i?M("videoinput").pipe(h({refCount:!0,bufferSize:1})):null,[i])}function se(i){return(0,p.useMemo)(()=>i?M("audioinput").pipe(h({refCount:!0,bufferSize:1})):null,[i])}export{Z as default};
//# sourceMappingURL=/build/routes/demo.rxjs-RF3VXFRN.js.map
